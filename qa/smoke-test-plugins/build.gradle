import org.elasticsearch.gradle.MavenFilteringHack

apply plugin: 'elasticsearch.rest-test'

ext.pluginCount = 0
for (Project subproj : project.rootProject.subprojects) {
  if (subproj.path.startsWith(':plugins:')) {
    integTest {
      def bundlePlugin = subproj.tasks.findByName('bundlePlugin')
      String camelName = subproj.name.replaceAll(/-(\w)/) { _, c -> c.toUpperCase() }
      dependsOn bundlePlugin
      cluster {
        plugin "install${camelName.capitalize()}", bundlePlugin.outputs.files
      }
    }
    pluginCount += 1
  }
} 

ext.expansions = [
  'expected.plugin.count': pluginCount
]

processTestResources {
  inputs.properties(expansions)
  MavenFilteringHack.filter(it, expansions)
}

